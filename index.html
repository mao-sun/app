<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- è§†å£è®¾ç½®ï¼šé€‚é…åˆ˜æµ·å±ï¼Œç¦æ­¢ç¼©æ”¾ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mao's Journey</title>
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F2F2F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet åœ°å›¾æ ·å¼ (ä½¿ç”¨ cdnjs) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <!-- Leaflet åœ°å›¾è„šæœ¬ (ä½¿ç”¨ cdnjs) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        :root {
            /* iOS 17 é£æ ¼é…è‰² */
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-text: #000000;
            --ios-subtext: #8E8E93;
            --ios-blue: #007AFF;
            --ios-separator: rgba(60, 60, 67, 0.12);
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-yellow: #FFD60A; /* ç”¨äºé«˜äº® */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            
            /* å¸ƒå±€é«˜åº¦å®šä¹‰ */
            --header-height: 160px;
            --footer-height: 80px;
        }

        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang SC", sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body { 
            background-color: var(--ios-bg);
            color: var(--ios-text);
            /* åŸºç¡€å†…è¾¹è·ï¼Œå…·ä½“è§†å›¾ä¼šè¦†ç›– */
            padding-top: calc(var(--header-height) + var(--safe-top));
            padding-bottom: calc(var(--footer-height) + var(--safe-bottom));
            height: 100vh;
            overflow: hidden; /* é˜²æ­¢ body æ»šåŠ¨ï¼Œç”±å†…éƒ¨å®¹å™¨æ»šåŠ¨ */
        }

        /* --- é¡¶éƒ¨å›ºå®šåŒºåŸŸ --- */
        .fixed-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: calc(var(--header-height) + var(--safe-top));
            background: rgba(242, 242, 247, 0.95);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            z-index: 2000; 
            padding-top: max(12px, var(--safe-top));
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .app-title {
            text-align: center;
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        /* æœç´¢æ¡†å®¹å™¨ */
        .search-wrapper {
            padding: 0 16px 12px;
            position: relative;
            flex-shrink: 0;
        }

        .search-input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-box {
            width: 100%;
            height: 40px;
            background: rgba(118, 118, 128, 0.12);
            border: none;
            border-radius: 10px;
            padding: 0 40px 0 36px;
            font-size: 17px;
            color: var(--ios-text);
        }
        
        .search-box:focus { outline: none; background: rgba(118, 118, 128, 0.18); }
        .search-icon { position: absolute; left: 10px; color: var(--ios-subtext); font-size: 16px; }
        .clear-btn { position: absolute; right: 10px; background: #8E8E93; color: white; border: none; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: none; align-items: center; justify-content: center; }
        .clear-btn.visible { display: flex; }

        /* åˆ†æ®µæ§åˆ¶å™¨ */
        .segmented-control {
            display: flex;
            margin: 0 16px 8px;
            background: rgba(118, 118, 128, 0.12);
            border-radius: 9px;
            padding: 2px;
            position: relative;
            flex-shrink: 0;
        }

        .segment-btn {
            flex: 1;
            text-align: center;
            padding: 6px 0;
            font-size: 13px;
            font-weight: 500;
            color: var(--ios-text);
            z-index: 2;
            cursor: pointer;
            transition: all 0.2s;
        }

        .segment-btn.active { font-weight: 600; }

        .segment-bg {
            position: absolute;
            top: 2px; left: 2px;
            width: calc(50% - 2px);
            height: calc(100% - 4px);
            background: #fff;
            border-radius: 7px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 1;
        }

        /* --- ä¸»å†…å®¹å®¹å™¨ --- */
        #mainContentContainer {
            position: absolute;
            top: calc(var(--header-height) + var(--safe-top));
            bottom: calc(var(--footer-height) + var(--safe-bottom));
            left: 0;
            right: 0;
            overflow: hidden; /* å†…éƒ¨å†³å®šæ»šåŠ¨ */
        }

        /* åˆ—è¡¨æ¨¡å¼ */
        .list-mode {
            height: 100%;
            overflow-y: auto; /* åˆ—è¡¨æ¨¡å¼å‚ç›´æ»šåŠ¨ */
            -webkit-overflow-scrolling: touch;
            padding: 10px 16px;
            display: none;
        }
        
        .list-mode.active-mode { display: block; }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active-view { display: block; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* åˆ—è¡¨å¡ç‰‡æ ·å¼ */
        .region-card { background: var(--ios-card); border-radius: 12px; margin-bottom: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .region-header { padding: 16px; display: flex; justify-content: space-between; align-items: center; font-size: 16px; font-weight: 600; cursor: pointer; border-bottom: 0.5px solid transparent; transition: background 0.2s; }
        .region-header:active { background: #F2F2F7; }
        .region-header:not(.collapsed) { border-bottom-color: var(--ios-separator); }
        .region-header span { display: flex; align-items: center; gap: 8px; }
        .region-header i { color: #C7C7CC; font-size: 14px; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); }
        .region-header.collapsed i { transform: rotate(-90deg); }
        .region-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; padding: 16px; background: var(--ios-card); align-items: stretch; }
        .region-content.collapsed { display: none; }
        
        .area-item { background: #F2F2F7; border-radius: 8px; padding: 12px 6px; text-align: center; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 14px; height: 100%; min-height: 70px; transition: transform 0.2s; }
        .area-item.china-item { justify-content: center; padding-top: 12px; padding-bottom: 12px; }
        .area-item.china-item span { margin-bottom: 0; }
        .area-item:active { transform: scale(0.96); }
        .area-item a { text-decoration: none; color: inherit; width: 100%; }
        .area-item span { font-size: 14px; font-weight: 500; white-space: normal; overflow: visible; text-overflow: unset; display: block; width: 100%; line-height: 1.35; margin-bottom: 2px; text-align: center; }
        .country-en { font-size: 10px; color: var(--ios-subtext); margin-top: 4px; white-space: normal; line-height: 1.25; word-wrap: break-word; width: 100%; padding: 0 2px; text-align: center; }
        
        .completed-badge { position: absolute; top: -6px; right: -6px; background: var(--ios-green); color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--ios-card); box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 2; }
        .highlight { background: #FFF4CE !important; box-shadow: 0 0 0 2px #FFD60A inset; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { transform: scale(1.05); } }

        /* --- åœ°å›¾æ¨¡å¼æ ·å¼ --- */
        .map-mode {
            height: 100%;
            width: 100%;
            display: none;
            position: relative;
        }
        
        .map-mode.active-mode { display: block; }
        
        #map-container {
            width: 100%;
            height: 100%;
            background: #e5e5ea; /* åœ°å›¾åŠ è½½å‰çš„èƒŒæ™¯è‰² */
            z-index: 1;
        }

        #mapid {
            width: 100%;
            height: 100%;
            /* å¼ºåˆ¶æœ€å°é«˜åº¦ï¼Œé˜²æ­¢å¡Œé™· */
            min-height: 400px; 
        }

        /* --- åº•éƒ¨å·¥å…·æ  --- */
        .bottom-toolbar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: calc(var(--footer-height) + var(--safe-bottom));
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-around;
            padding-bottom: var(--safe-bottom);
            z-index: 2000;
            padding-top: 10px;
        }

        .tool-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            color: var(--ios-subtext);
            font-size: 10px;
            gap: 4px;
            cursor: pointer;
        }
        
        .tool-btn i { font-size: 22px; }
        .tool-btn:active { opacity: 0.7; }
        .tool-btn.active { color: var(--ios-blue); }

        /* æœç´¢å»ºè®® */
        .suggestions-container {
            position: fixed;
            top: calc(var(--header-height) + var(--safe-top) - 10px); 
            left: 16px; right: 16px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            max-height: 50vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 3000;
            display: none;
        }
        .suggestion-item { padding: 14px 16px; border-bottom: 0.5px solid var(--ios-separator); display: flex; justify-content: space-between; align-items: center; }
        .highlight-text { color: var(--ios-blue); font-weight: 600; }
        .search-btn-hidden { display: none; }

        /* Toast */
        .toast-msg {
            position: fixed; 
            bottom: calc(var(--footer-height) + var(--safe-bottom) + 16px); 
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 4000;
            white-space: nowrap;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toast-msg.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div class="fixed-header">
        <div class="app-title">Mao's Journey</div>
        <div class="search-wrapper">
            <div class="search-input-group">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-box" id="searchInput" placeholder="æœç´¢ç›®çš„åœ° (å¦‚: æ—¥æœ¬)">
                <button class="clear-btn" id="clearBtn"><i class="fas fa-times"></i></button>
            </div>
            <button id="searchButton" class="search-btn-hidden"></button>
        </div>
        <div class="segmented-control">
            <div class="segment-bg" id="segmentBg"></div>
            <div class="segment-btn active" data-tab="china" onclick="switchTab('china', this)">ğŸ‡¨ğŸ‡³ æ¢ç´¢ä¸­å›½</div>
            <div class="segment-btn" data-tab="world" onclick="switchTab('world', this)">ğŸŒ ç¯æ¸¸ä¸–ç•Œ</div>
        </div>
    </div>

    <div class="suggestions-container" id="suggestionsContainer"></div>
    
    <div id="mainContentContainer">
        <!-- åˆ—è¡¨æ¨¡å¼ -->
        <div id="list-view" class="view-mode active-mode list-mode">
            <!-- ä¸­å›½åˆ—è¡¨ -->
            <div id="tab-china" class="tab-content active-view">
                <div class="region-card"><div class="region-header" data-region="northNortheastChina"><span>ååŒ—-ä¸œåŒ—åœ°åŒº</span><i class="fas fa-chevron-down"></i></div><div class="region-content" id="northNortheastChinaContent"></div></div>
                <div class="region-card"><div class="region-header" data-region="eastChina"><span>åä¸œåœ°åŒº</span><i class="fas fa-chevron-down"></i></div><div class="region-content" id="eastChinaContent"></div></div>
                <div class="region-card"><div class="region-header" data-region="centralSouthChina"><span>åä¸­-åå—åœ°åŒº</span><i class="fas fa-chevron-down"></i></div><div class="region-content" id="centralSouthChinaContent"></div></div>
                <div class="region-card"><div class="region-header" data-region="southwestChina"><span>è¥¿å—åœ°åŒº</span><i class="fas fa-chevron-down"></i></div><div class="region-content" id="southwestChinaContent"></div></div>
                <div class="region-card"><div class="region-header" data-region="northwestChina"><span>è¥¿åŒ—åœ°åŒº</span><i class="fas fa-chevron-down"></i></div><div class="region-content" id="northwestChinaContent"></div></div>
                <div class="region-card"><div class="region-header" data-region="hmtChina"><span>æ¸¯æ¾³å°åœ°åŒº</span><i class="fas fa-chevron-down"></i></div><div class="region-content" id="hmtChinaContent"></div></div>
            </div>
            <!-- ä¸–ç•Œåˆ—è¡¨ -->
            <div id="tab-world" class="tab-content">
                <div class="region-card"><div class="region-header" data-region="asia"><span>äºšæ´² (Asia)</span><i class="fas fa-chevron-down"></i></div><div class="region-content" id="asiaContent"></div></div>
                <div class="region-card"><div class="region-header" data-region="europe"><span>æ¬§æ´² (Europe)</span><i class="fas fa-chevron-down"></i></div><div class="region-content" id="europeContent"></div></div>
                <div class="region-card"><div class="region-header" data-region="northAmerica"><span>åŒ—ç¾æ´² (North America)</span><i class="fas fa-chevron-down"></i></div><div class="region-content" id="northAmericaContent"></div></div>
                <div class="region-card"><div class="region-header" data-region="southAmerica"><span>å—ç¾æ´² (South America)</span><i class="fas fa-chevron-down"></i></div><div class="region-content" id="southAmericaContent"></div></div>
                <div class="region-card"><div class="region-header" data-region="oceania"><span>å¤§æ´‹æ´² (Oceania)</span><i class="fas fa-chevron-down"></i></div><div class="region-content" id="oceaniaContent"></div></div>
                <div class="region-card"><div class="region-header" data-region="africa"><span>éæ´² (Africa)</span><i class="fas fa-chevron-down"></i></div><div class="region-content" id="africaContent"></div></div>
            </div>
        </div>

        <!-- åœ°å›¾æ¨¡å¼ -->
        <div id="map-view" class="view-mode map-mode">
            <div id="map-container">
                <div id="mapid"></div>
            </div>
        </div>
    </div>

    <div class="bottom-toolbar">
        <div class="tool-btn" id="hintBtn">
            <i class="far fa-question-circle"></i>
            <span>è¯´æ˜</span>
        </div>
        <div class="tool-btn" id="viewModeBtn">
            <i class="fas fa-map-marked-alt"></i>
            <span>åœ°å›¾æ¨¡å¼</span>
        </div>
        <div class="tool-btn" id="collapseExpandBtn">
            <i class="fas fa-compress-alt"></i>
            <span>æŠ˜å /å±•å¼€</span>
        </div>
        <div class="tool-btn" id="backToTop">
            <i class="fas fa-arrow-up"></i>
            <span>é¡¶éƒ¨</span>
        </div>
    </div>

    <div class="toast-msg" id="hintPanel"></div>

    <script>
        // æ ¸å¿ƒæ•°æ® - å·²å®Œå…¨æ¢å¤ä¸ºæ‚¨åŸå§‹çš„å®Œæ•´åˆ—è¡¨
        const completedChinaProvinces = ["åŒ—äº¬å¸‚", "æ±Ÿè‹çœ", "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº", "å››å·çœ", "é‡åº†å¸‚"];
        const chinaRegions = {
            northNortheastChina: ["åŒ—äº¬å¸‚", "å¤©æ´¥å¸‚", "æ²³åŒ—çœ", "å±±è¥¿çœ", "å†…è’™å¤è‡ªæ²»åŒº", "è¾½å®çœ", "å‰æ—çœ", "é»‘é¾™æ±Ÿçœ"],
            eastChina: ["ä¸Šæµ·å¸‚", "æ±Ÿè‹çœ", "æµ™æ±Ÿçœ", "å®‰å¾½çœ", "ç¦å»ºçœ", "æ±Ÿè¥¿çœ", "å±±ä¸œçœ"],
            centralSouthChina: ["æ²³å—çœ", "æ¹–åŒ—çœ", "æ¹–å—çœ", "å¹¿ä¸œçœ", "å¹¿è¥¿å£®æ—è‡ªæ²»åŒº", "æµ·å—çœ"],
            southwestChina: ["é‡åº†å¸‚", "å››å·çœ", "è´µå·çœ", "äº‘å—çœ", "è¥¿è—è‡ªæ²»åŒº"],
            northwestChina: ["é™•è¥¿çœ", "ç”˜è‚ƒçœ", "é’æµ·çœ", "å®å¤å›æ—è‡ªæ²»åŒº", "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº"],
            hmtChina: ["é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº", "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº", "å°æ¹¾çœ"]
        };
        const countries = {
            asia: [
                {name: "æ—¥æœ¬", en: "Japan", completed: true},
                {name: "éŸ©å›½", en: "South Korea", completed: false},
                {name: "è¶Šå—", en: "Vietnam", completed: true},
                {name: "æ³°å›½", en: "Thailand", completed: false},
                {name: "æ–°åŠ å¡", en: "Singapore", completed: false},
                {name: "é©¬æ¥è¥¿äºš", en: "Malaysia", completed: false},
                {name: "å°åº¦å°¼è¥¿äºš", en: "Indonesia", completed: false},
                {name: "è²å¾‹å®¾", en: "Philippines", completed: false},
                {name: "æŸ¬åŸ”å¯¨", en: "Cambodia", completed: false},
                {name: "è€æŒ", en: "Laos", completed: false},
                {name: "æ–¯é‡Œå…°å¡", en: "Sri Lanka", completed: false},
                {name: "é©¬å°”ä»£å¤«", en: "Maldives", completed: false},
                {name: "é˜¿è”é…‹", en: "United Arab Emirates", completed: false},
                {name: "åœŸè€³å…¶", en: "Turkey", completed: false},
                {name: "ä¸­å›½é¦™æ¸¯", en: "Hong Kong, China", completed: true},
                {name: "ä¸­å›½æ¾³é—¨", en: "Macao, China", completed: false},
                {name: "ä¸­å›½å°æ¹¾", en: "Taiwan, China", completed: false}
            ],
            europe: [
                {name: "è‹±å›½", en: "United Kingdom", completed: false},
                {name: "æ³•å›½", en: "France", completed: false},
                {name: "å¾·å›½", en: "Germany", completed: false},
                {name: "æ„å¤§åˆ©", en: "Italy", completed: false},
                {name: "è¥¿ç­ç‰™", en: "Spain", completed: false},
                {name: "è‘¡è„ç‰™", en: "Portugal", completed: false},
                {name: "è·å…°", en: "Netherlands", completed: false},
                {name: "æ¯”åˆ©æ—¶", en: "Belgium", completed: false},
                {name: "ç‘å£«", en: "Switzerland", completed: false},
                {name: "å¥¥åœ°åˆ©", en: "Austria", completed: false},
                {name: "å¸Œè…Š", en: "Greece", completed: false},
                {name: "å†°å²›", en: "Iceland", completed: false},
                {name: "æŒªå¨", en: "Norway", completed: false},
                {name: "ç‘å…¸", en: "Sweden", completed: false},
                {name: "ä¸¹éº¦", en: "Denmark", completed: false},
                {name: "èŠ¬å…°", en: "Finland", completed: false},
                {name: "ä¿„ç½—æ–¯", en: "Russia", completed: false},
                {name: "æ·å…‹", en: "Czech Republic", completed: false},
                {name: "åŒˆç‰™åˆ©", en: "Hungary", completed: false},
                {name: "æ³¢å…°", en: "Poland", completed: false}
            ],
            northAmerica: [
                {name: "ç¾å›½", en: "United States", completed: false},
                {name: "åŠ æ‹¿å¤§", en: "Canada", completed: false},
                {name: "å¢¨è¥¿å“¥", en: "Mexico", completed: false},
                {name: "å¤å·´", en: "Cuba", completed: false},
                {name: "å“¥æ–¯è¾¾é»åŠ ", en: "Costa Rica", completed: false},
                {name: "å·´æ‹¿é©¬", en: "Panama", completed: false}
            ],
            southAmerica: [
                {name: "å·´è¥¿", en: "Brazil", completed: false},
                {name: "é˜¿æ ¹å»·", en: "Argentina", completed: false},
                {name: "æ™ºåˆ©", en: "Chile", completed: false},
                {name: "ç§˜é²", en: "Peru", completed: false},
                {name: "å“¥ä¼¦æ¯”äºš", en: "Colombia", completed: false}
            ],
            oceania: [
                {name: "æ¾³å¤§åˆ©äºš", en: "Australia", completed: false},
                {name: "æ–°è¥¿å…°", en: "New Zealand", completed: false},
                {name: "æ–æµ", en: "Fiji", completed: false},
                {name: "è¨æ‘©äºš", en: "Samoa", completed: false},
                {name: "æ±¤åŠ ", en: "Tonga", completed: false},
                {name: "æ³•å±æ³¢åˆ©å°¼è¥¿äºš", en: "French Polynesia", completed: false}
            ],
            africa: [
                {name: "åŸƒåŠ", en: "Egypt", completed: false},
                {name: "å—é", en: "South Africa", completed: false},
                {name: "è‚¯å°¼äºš", en: "Kenya", completed: false},
                {name: "æ‘©æ´›å“¥", en: "Morocco", completed: false},
                {name: "å¦æ¡‘å°¼äºš", en: "Tanzania", completed: false}
            ]
        };
        
        // åæ ‡æ•°æ® (çœŸå®ç»çº¬åº¦)
        const coords = {
            // ä¸­å›½
            "åŒ—äº¬å¸‚": [39.90, 116.40], "å¤©æ´¥å¸‚": [39.08, 117.20], "æ²³åŒ—çœ": [38.03, 114.51], "å±±è¥¿çœ": [37.87, 112.53], "å†…è’™å¤è‡ªæ²»åŒº": [40.84, 111.75], "è¾½å®çœ": [41.80, 123.38], "å‰æ—çœ": [43.81, 125.32], "é»‘é¾™æ±Ÿçœ": [45.75, 126.63],
            "ä¸Šæµ·å¸‚": [31.23, 121.47], "æ±Ÿè‹çœ": [32.06, 118.76], "æµ™æ±Ÿçœ": [30.26, 120.19], "å®‰å¾½çœ": [31.86, 117.27], "ç¦å»ºçœ": [26.08, 119.30], "æ±Ÿè¥¿çœ": [28.68, 115.89], "å±±ä¸œçœ": [36.65, 117.00],
            "æ²³å—çœ": [34.76, 113.65], "æ¹–åŒ—çœ": [30.54, 114.31], "æ¹–å—çœ": [28.19, 112.97], "å¹¿ä¸œçœ": [23.13, 113.26], "å¹¿è¥¿å£®æ—è‡ªæ²»åŒº": [22.82, 108.32], "æµ·å—çœ": [20.02, 110.35],
            "é‡åº†å¸‚": [29.56, 106.55], "å››å·çœ": [30.67, 104.06], "è´µå·çœ": [26.58, 106.71], "äº‘å—çœ": [25.04, 102.71], "è¥¿è—è‡ªæ²»åŒº": [29.65, 91.13],
            "é™•è¥¿çœ": [34.26, 108.95], "ç”˜è‚ƒçœ": [36.03, 103.73], "é’æµ·çœ": [36.62, 101.74], "å®å¤å›æ—è‡ªæ²»åŒº": [38.47, 106.27], "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº": [43.79, 87.61],
            "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº": [22.32, 114.17], "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº": [22.19, 113.54], "å°æ¹¾çœ": [25.03, 121.56],
            
            // äºšæ´²
            "æ—¥æœ¬": [36.20, 138.25], "éŸ©å›½": [35.90, 127.76], "è¶Šå—": [14.05, 108.27], "æ³°å›½": [15.87, 100.99], "æ–°åŠ å¡": [1.35, 103.81], "é©¬æ¥è¥¿äºš": [4.21, 101.97], "å°åº¦å°¼è¥¿äºš": [-0.78, 113.92], "è²å¾‹å®¾": [12.87, 121.77],
            "æŸ¬åŸ”å¯¨": [12.56, 104.99], "è€æŒ": [19.85, 102.49], "æ–¯é‡Œå…°å¡": [7.87, 80.77], "é©¬å°”ä»£å¤«": [3.20, 73.22], "é˜¿è”é…‹": [23.42, 53.84], "åœŸè€³å…¶": [38.96, 35.24],
            "ä¸­å›½é¦™æ¸¯": [22.32, 114.17], "ä¸­å›½æ¾³é—¨": [22.19, 113.54], "ä¸­å›½å°æ¹¾": [25.03, 121.56],

            // æ¬§æ´²
            "è‹±å›½": [55.37, -3.43], "æ³•å›½": [46.22, 2.21], "å¾·å›½": [51.16, 10.45], "æ„å¤§åˆ©": [41.87, 12.56], "è¥¿ç­ç‰™": [40.46, -3.74], "è‘¡è„ç‰™": [39.39, -8.22], "è·å…°": [52.13, 5.29], "æ¯”åˆ©æ—¶": [50.50, 4.46], "ç‘å£«": [46.81, 8.22], "å¥¥åœ°åˆ©": [47.51, 14.55], "å¸Œè…Š": [39.07, 21.82], "å†°å²›": [64.96, -19.02], "æŒªå¨": [60.47, 8.46], "ç‘å…¸": [60.12, 18.64], "ä¸¹éº¦": [56.26, 9.50], "èŠ¬å…°": [61.92, 25.74], "ä¿„ç½—æ–¯": [61.52, 105.31], "æ·å…‹": [49.81, 15.47], "åŒˆç‰™åˆ©": [47.16, 19.50], "æ³¢å…°": [51.91, 19.14],

            // åŒ—ç¾æ´²
            "ç¾å›½": [37.09, -95.71], "åŠ æ‹¿å¤§": [56.13, -106.34], "å¢¨è¥¿å“¥": [23.63, -102.55], "å¤å·´": [21.52, -77.78], "å“¥æ–¯è¾¾é»åŠ ": [9.74, -83.75], "å·´æ‹¿é©¬": [8.53, -80.78],

            // å—ç¾æ´²
            "å·´è¥¿": [-14.23, -51.92], "é˜¿æ ¹å»·": [-38.41, -63.61], "æ™ºåˆ©": [-35.67, -71.54], "ç§˜é²": [-9.19, -75.01], "å“¥ä¼¦æ¯”äºš": [4.57, -74.29],

            // å¤§æ´‹æ´²
            "æ¾³å¤§åˆ©äºš": [-25.27, 133.77], "æ–°è¥¿å…°": [-40.90, 174.88], "æ–æµ": [-17.71, 178.06], "è¨æ‘©äºš": [-13.75, -172.10], "æ±¤åŠ ": [-21.17, -175.19], "æ³•å±æ³¢åˆ©å°¼è¥¿äºš": [-17.67, -149.40],

            // éæ´²
            "åŸƒåŠ": [26.82, 30.80], "å—é": [-30.55, 22.93], "è‚¯å°¼äºš": [-0.02, 37.90], "æ‘©æ´›å“¥": [31.79, -7.09], "å¦æ¡‘å°¼äºš": [-6.36, 34.88]
        };

        const provinceRegionMap = {"åŒ—äº¬å¸‚": "NorthChina", "å¤©æ´¥å¸‚": "NorthChina", "æ²³åŒ—çœ": "NorthChina", "å±±è¥¿çœ": "NorthChina", "å†…è’™å¤è‡ªæ²»åŒº": "NorthChina", "è¾½å®çœ": "NortheastChina", "å‰æ—çœ": "NortheastChina", "é»‘é¾™æ±Ÿçœ": "NortheastChina", "ä¸Šæµ·å¸‚": "EastChina", "æ±Ÿè‹çœ": "EastChina", "æµ™æ±Ÿçœ": "EastChina", "å®‰å¾½çœ": "EastChina", "ç¦å»ºçœ": "EastChina", "æ±Ÿè¥¿çœ": "EastChina", "å±±ä¸œçœ": "EastChina", "æ²³å—çœ": "CentralChina", "æ¹–åŒ—çœ": "CentralChina", "æ¹–å—çœ": "CentralChina", "å¹¿ä¸œçœ": "SouthChina", "å¹¿è¥¿å£®æ—è‡ªæ²»åŒº": "SouthChina", "æµ·å—çœ": "SouthChina", "é‡åº†å¸‚": "SouthwestChina", "å››å·çœ": "SouthwestChina", "è´µå·çœ": "SouthwestChina", "äº‘å—çœ": "SouthwestChina", "è¥¿è—è‡ªæ²»åŒº": "SouthwestChina", "é™•è¥¿çœ": "NorthwestChina", "ç”˜è‚ƒçœ": "NorthwestChina", "é’æµ·çœ": "NorthwestChina", "å®å¤å›æ—è‡ªæ²»åŒº": "NorthwestChina", "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº": "NorthwestChina", "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº": "China", "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº": "China", "å°æ¹¾çœ": "China"};
        const provinceEnMap = {"åŒ—äº¬å¸‚": "Beijing", "å¤©æ´¥å¸‚": "Tianjin", "æ²³åŒ—çœ": "Hebei", "å±±è¥¿çœ": "Shanxi", "å†…è’™å¤è‡ªæ²»åŒº": "InnerMongolia", "è¾½å®çœ": "Liaoning", "å‰æ—çœ": "Jilin", "é»‘é¾™æ±Ÿçœ": "Heilongjiang", "ä¸Šæµ·å¸‚": "Shanghai", "æ±Ÿè‹çœ": "Jiangsu", "æµ™æ±Ÿçœ": "Zhejiang", "å®‰å¾½çœ": "Anhui", "ç¦å»ºçœ": "Fujian", "æ±Ÿè¥¿çœ": "Jiangxi", "å±±ä¸œçœ": "Shandong", "æ²³å—çœ": "Henan", "æ¹–åŒ—çœ": "Hubei", "æ¹–å—çœ": "Hunan", "å¹¿ä¸œçœ": "Guangdong", "å¹¿è¥¿å£®æ—è‡ªæ²»åŒº": "Guangxi", "æµ·å—çœ": "Hainan", "é‡åº†å¸‚": "Chongqing", "å››å·çœ": "Sichuan", "è´µå·çœ": "Guizhou", "äº‘å—çœ": "Yunnan", "è¥¿è—è‡ªæ²»åŒº": "Tibet", "é™•è¥¿çœ": "Shaanxi", "ç”˜è‚ƒçœ": "Gansu", "é’æµ·çœ": "Qinghai", "å®å¤å›æ—è‡ªæ²»åŒº": "Ningxia", "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº": "Xinjiang", "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº": "HongKong", "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº": "Macao", "å°æ¹¾çœ": "Taiwan"};
        const specialNameMap = { "ä¸­å›½é¦™æ¸¯": "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº", "ä¸­å›½æ¾³é—¨": "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº", "ä¸­å›½å°æ¹¾": "å°æ¹¾çœ" };

        let allDestinations = [];
        let currentViewMode = 'list';
        let currentTab = 'china';
        let map = null;
        let markersLayer = null;

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', () => {
            initData();
            initUI();
            showToast('æ¬¢è¿ä½¿ç”¨ Mao\'s Journey!', 'fas fa-smile', '#007AFF');
        });

        function initData() {
            // å±•å¹³æ•°æ®
            for (let region in chinaRegions) {
                chinaRegions[region].forEach(p => {
                    allDestinations.push({
                        name: p,
                        en: provinceEnMap[p],
                        type: 'china',
                        completed: completedChinaProvinces.includes(p),
                        regionCode: region
                    });
                });
            }
            for (let continent in countries) {
                countries[continent].forEach(c => {
                    allDestinations.push({
                        name: c.name,
                        en: c.en,
                        type: 'world',
                        completed: c.completed
                    });
                });
            }
            renderList();
        }

        function renderList() {
            // å¡«å……ä¸­å›½åˆ—è¡¨
            for (let region in chinaRegions) {
                const container = document.getElementById(region + 'Content');
                if (!container) continue;
                container.innerHTML = '';
                chinaRegions[region].forEach(p => {
                    const isDone = completedChinaProvinces.includes(p);
                    const el = document.createElement('div');
                    el.className = 'area-item china-item' + (isDone ? ' completed' : '');
                    el.innerHTML = `
                        ${isDone ? '<div class="completed-badge"><i class="fas fa-check"></i></div>' : ''}
                        <a href="#"><span>${p}</span></a>
                    `;
                    // ç»‘å®šç‚¹å‡»äº‹ä»¶ä»¥é«˜äº®
                    el.addEventListener('click', (e) => {
                        e.preventDefault();
                        showToast(`å·²é€‰æ‹©ï¼š${p}`, 'fas fa-map-pin', '#007AFF');
                    });
                    // å­˜å‚¨å…ƒç´ å¼•ç”¨ä»¥ä¾¿æœç´¢é«˜äº®
                    const dest = allDestinations.find(d => d.name === p);
                    if(dest) dest.element = el;
                    container.appendChild(el);
                });
            }

            // å¡«å……ä¸–ç•Œåˆ—è¡¨
            for (let continent in countries) {
                const container = document.getElementById(continent + 'Content');
                if (!container) continue;
                container.innerHTML = '';
                countries[continent].forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'area-item';
                    el.innerHTML = `
                        ${c.completed ? '<div class="completed-badge"><i class="fas fa-check"></i></div>' : ''}
                        <a href="#"><span>${c.name}</span><span class="country-en">${c.en}</span></a>
                    `;
                    el.addEventListener('click', (e) => {
                        e.preventDefault();
                        showToast(`å·²é€‰æ‹©ï¼š${c.name}`, 'fas fa-map-pin', '#007AFF');
                    });
                    const dest = allDestinations.find(d => d.name === c.name);
                    if(dest) dest.element = el;
                    container.appendChild(el);
                });
            }
        }

        function initUI() {
            // æŠ˜å /å±•å¼€
            document.querySelectorAll('.region-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('collapsed');
                    const content = header.nextElementSibling;
                    if(content) content.classList.toggle('collapsed');
                });
            });
            // é»˜è®¤æŠ˜å 
            document.querySelectorAll('.region-header').forEach(h => h.click());

            // å…¨å±€æŠ˜å æŒ‰é’®
            document.getElementById('collapseExpandBtn').addEventListener('click', () => {
                if(currentViewMode !== 'list') return;
                const activeContent = document.querySelector('.tab-content.active-view');
                if(!activeContent) return;
                const headers = activeContent.querySelectorAll('.region-header');
                const anyExpanded = Array.from(headers).some(h => !h.classList.contains('collapsed'));
                headers.forEach(h => {
                    if (anyExpanded) {
                        if (!h.classList.contains('collapsed')) h.click();
                    } else {
                        if (h.classList.contains('collapsed')) h.click();
                    }
                });
            });

            // é¡¶éƒ¨/åº•éƒ¨æŒ‰é’®
            document.getElementById('backToTop').addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));
            document.getElementById('hintBtn').addEventListener('click', () => showToast('ç»¿è‰²æ ‡è®°ä¸ºå·²å®Œæˆï¼Œç‚¹å‡»åˆ—è¡¨æˆ–åœ°å›¾å¯æŸ¥çœ‹è¯¦æƒ…', 'fas fa-info', '#007AFF', 4000));
            
            // è§†å›¾åˆ‡æ¢
            document.getElementById('viewModeBtn').addEventListener('click', toggleViewMode);
            
            // æœç´¢
            document.getElementById('searchButton').addEventListener('click', performSearch);
            document.getElementById('clearBtn').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                document.getElementById('suggestionsContainer').style.display = 'none';
            });
            document.getElementById('searchInput').addEventListener('input', handleSearchInput);
        }

        // --- æœç´¢é€»è¾‘ ---
        function handleSearchInput(e) {
            const val = e.target.value.trim().toLowerCase();
            const container = document.getElementById('suggestionsContainer');
            document.getElementById('clearBtn').style.display = val ? 'flex' : 'none';
            
            if (!val) {
                container.style.display = 'none';
                return;
            }

            const matches = allDestinations.filter(d => d.name.includes(val) || (d.en && d.en.toLowerCase().includes(val)));
            container.innerHTML = '';
            if (matches.length > 0) {
                container.style.display = 'block';
                matches.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `<span class="highlight-text">${m.name}</span> <span style="color:#999;font-size:12px;">${m.en || ''}</span>`;
                    div.onclick = () => {
                        document.getElementById('searchInput').value = m.name;
                        container.style.display = 'none';
                        performSearch();
                    };
                    container.appendChild(div);
                });
            } else {
                container.style.display = 'none';
            }
        }

        function performSearch() {
            const val = document.getElementById('searchInput').value.trim();
            if (!val) return;
            
            // æ˜ å°„å¤„ç† (å¦‚è¾“å…¥"é¦™æ¸¯")
            let targetName = val;
            if (specialNameMap[val]) targetName = specialNameMap[val];
            else {
                // å°è¯•éƒ¨åˆ†åŒ¹é…
                const found = allDestinations.find(d => d.name === val || d.name.includes(val));
                if(found) targetName = found.name;
            }

            const dest = allDestinations.find(d => d.name === targetName);
            if (dest) {
                // 1. åˆ‡æ¢åˆ°å¯¹åº” Tab
                const targetTab = (dest.type === 'china') ? 'china' : 'world';
                if (currentTab !== targetTab) switchTab(targetTab, document.querySelector(`.segment-btn[data-tab="${targetTab}"]`));

                // 2. å¦‚æœåœ¨åˆ—è¡¨æ¨¡å¼
                if (currentViewMode === 'list') {
                    if (dest.element) {
                        // å±•å¼€çˆ¶çº§
                        const header = dest.element.closest('.region-content').previousElementSibling;
                        if (header && header.classList.contains('collapsed')) header.click();
                        // æ»šåŠ¨å¹¶é«˜äº®
                        dest.element.scrollIntoView({behavior: 'smooth', block: 'center'});
                        dest.element.classList.add('highlight');
                        setTimeout(() => dest.element.classList.remove('highlight'), 2000);
                    }
                } 
                // 3. å¦‚æœåœ¨åœ°å›¾æ¨¡å¼
                else if (map) {
                    const pos = coords[dest.name];
                    if (pos) {
                        map.flyTo(pos, 6, {duration: 1.5});
                        // æ‰¾åˆ°å¯¹åº” marker å¹¶æ‰“å¼€ popup
                        if (markersLayer) {
                            markersLayer.eachLayer(layer => {
                                if (layer.options.title === dest.name) {
                                    layer.openPopup();
                                }
                            });
                        }
                    }
                }
                showToast(`å·²å®šä½ï¼š${dest.name}`, 'fas fa-location-arrow', '#34C759');
            } else {
                showToast('æœªæ‰¾åˆ°è¯¥ç›®çš„åœ°', 'fas fa-times-circle', '#FF3B30');
            }
        }

        // --- è§†å›¾åˆ‡æ¢ä¸åœ°å›¾ ---
        window.switchTab = function(tab, btn) {
            if (currentTab === tab) return;
            currentTab = tab;
            
            // UI æ›´æ–°
            document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('segmentBg').style.transform = tab === 'china' ? 'translateX(0)' : 'translateX(100%)';

            // åˆ—è¡¨æ˜¾ç¤ºåˆ‡æ¢
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active-view'));
            document.getElementById('tab-' + tab).classList.add('active-view');

            // å¦‚æœåœ¨åœ°å›¾æ¨¡å¼ï¼Œæ›´æ–°åœ°å›¾è§†å›¾
            if (currentViewMode === 'map' && map) {
                // å®šä¹‰è§†å›¾æ•°æ® (å»¶è¿Ÿåˆ°è¿™é‡Œä½¿ç”¨ï¼Œé¿å… L æœªåŠ è½½æ—¶å‡ºé”™)
                const worldViewBounds = [[-90, -180], [90, 180]];
                const chinaViewBounds = [[0, 70], [60, 140]];
                
                updateMapMarkers();
                
                // ä½¿ç”¨ flyToBounds åˆ‡æ¢è§†å›¾
                const bounds = (tab === 'china') ? chinaViewBounds : worldViewBounds;
                // ä½¿ç”¨ L.latLngBounds ç¡®ä¿æ ¼å¼æ­£ç¡®
                map.flyToBounds(L.latLngBounds(bounds), { duration: 1.5 });
            }
            window.scrollTo({top:0});
        }

        window.toggleViewMode = function() {
            const btn = document.getElementById('viewModeBtn');
            const listDiv = document.getElementById('list-view');
            const mapDiv = document.getElementById('map-view');
            
            if (currentViewMode === 'list') {
                currentViewMode = 'map';
                listDiv.classList.remove('active-mode');
                mapDiv.classList.add('active-mode');
                btn.innerHTML = '<i class="fas fa-list"></i><span>åˆ—è¡¨æ¨¡å¼</span>';
                btn.classList.add('active');
                
                // åˆå§‹åŒ–åœ°å›¾ (å¦‚æœå°šæœªåˆå§‹åŒ–)
                if (!map) {
                    setTimeout(initMap, 100); // å»¶æ—¶ç¡®ä¿å®¹å™¨å¯è§
                } else {
                    setTimeout(() => { 
                        map.invalidateSize(); 
                        // é‡æ–°èšç„¦å½“å‰è§†å›¾
                        const bounds = (currentTab === 'china') ? [[0, 70], [60, 140]] : [[-90, -180], [90, 180]];
                        map.fitBounds(L.latLngBounds(bounds));
                    }, 200);
                }
            } else {
                currentViewMode = 'list';
                mapDiv.classList.remove('active-mode');
                listDiv.classList.add('active-mode');
                btn.innerHTML = '<i class="fas fa-map-marked-alt"></i><span>åœ°å›¾æ¨¡å¼</span>';
                btn.classList.remove('active');
            }
        }

        function initMap() {
            if (typeof L === 'undefined') {
                showToast('åœ°å›¾èµ„æºåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'fas fa-exclamation-triangle', '#FF3B30');
                return;
            }
            
            map = L.map('mapid', {
                center: [36, 105],
                zoom: 4,
                zoomControl: false,
                attributionControl: false
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            markersLayer = L.layerGroup().addTo(map);
            updateMapMarkers();
            
            // åˆå§‹è§†å›¾èšç„¦ä¸­å›½
            map.fitBounds(L.latLngBounds([[0, 70], [60, 140]]));
        }

        function updateMapMarkers() {
            if (!map || !markersLayer) return;
            markersLayer.clearLayers();

            const targets = allDestinations.filter(d => d.type === currentTab || (currentTab === 'world' && d.type === 'world'));
            
            targets.forEach(dest => {
                const pos = coords[dest.name];
                if (pos) {
                    const color = dest.completed ? '#34C759' : '#8E8E93';
                    const marker = L.circleMarker(pos, {
                        radius: 8,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8,
                        title: dest.name // ç”¨äºæœç´¢å®šä½
                    });
                    
                    marker.bindPopup(`<b>${dest.name}</b><br>${dest.en}<br>${dest.completed ? 'âœ… å·²æ‰“å¡' : 'âšª æœªæ‰“å¡'}`);
                    markersLayer.addLayer(marker);
                }
            });
        }

        function showToast(msg, icon, color, duration=3000) {
            const p = document.getElementById('hintPanel');
            p.innerHTML = `<i class="${icon}" style="color:${color}"></i> ${msg}`;
            p.classList.add('show');
            if (p.timer) clearTimeout(p.timer);
            p.timer = setTimeout(() => p.classList.remove('show'), duration);
        }
    </script>
</body>
</html>
